# Copilot Instructions for Photo Open Call Analyzer

## Project Overview

**Photo Open Call Analyzer** is a Node.js CLI tool that uses **Ollama + LLaVA vision model** to analyze photographs against photography open call criteria. It's designed for photographers to objectively rank their submissions based on competition-specific evaluation frameworks.

### Core Architecture Pattern

```
Open Call Config (open-call.json)
    ↓
Prompt Generator → Ollama LLM → Structured Analysis Prompt with Criteria
    ↓
Photo Batch → Photo Analyzer → Individual Scores via LLaVA Vision Model
    ↓
Score Aggregator → Rankings, Tiers & Statistics
    ↓
Report Generator → Markdown/JSON/CSV Exports
```

## Critical Workflows

### End-to-End Analysis Workflow
1. **User provides** `data/open-calls/{call-name}/open-call.json` with competition metadata (title, theme, jury, pastWinners)
2. **generateAnalysisPrompt()** → Ollama LLM creates structured evaluation criteria prompt from competition context
3. **processBatch()** → Scans `{call-name}/photos/` directory, validates formats (jpg, png, gif, webp), spawns parallel `analyzePhoto()` calls (default 3 concurrent, configurable)
4. **analyzePhoto()** → Sends base64-encoded image + criteria prompt to LLaVA model, sets temperature=0.3 for consistent scoring, parses LLM response into individual criterion scores (1-10 scale)
5. **aggregateScores()** → Combines individual scores, calculates weighted averages, generates ranking and statistical analysis
6. **exportReports()** → Generates Markdown summary (human-readable), JSON details (programmatic use), and CSV (spreadsheet import)

### Data Flow: Input to Output
- **Input**: `open-call.json` metadata + photo directory
- **Intermediate**: `analysis-prompt.json` (generated by Ollama), individual photo analysis results
- **Output**: `photo-analysis.md`, `photo-analysis.json`, `photo-analysis.csv` in results directory

### Key Integration Points
- **Ollama Connection**: [src/utils/api-client.js](src/utils/api-client.js) - Lazy-initialized singleton client with `OLLAMA_HOST` (default: http://localhost:11434), `OLLAMA_MODEL` (default: llava:7b)
- **Vision Analysis**: [src/analysis/photo-analyzer.js](src/analysis/photo-analyzer.js) - Sends images as base64, parses criterion scores from LLM text response
- **Prompt Generation**: [src/analysis/prompt-generator.js](src/analysis/prompt-generator.js) - Uses Ollama to create evaluation criteria from competition context (not just template-based)
- **Batch Processing**: [src/processing/batch-processor.js](src/processing/batch-processor.js) - Supports concurrent analysis with configurable parallelism and error recovery
- **CLI Entry**: [src/cli/analyze.js](src/cli/analyze.js) - Commander.js program with `analyze`, `validate`, and `analyze-single` subcommands

## Project Conventions

### Code Structure
- **Files**: kebab-case (`photo-analyzer.js`, `batch-processor.js`)
- **Functions/Variables**: camelCase (`analyzePhoto()`, `processBatch()`)
- **Classes**: PascalCase (rarely used)
- **Constants**: UPPER_SNAKE (`SUPPORTED_FORMATS`)
- **Module System**: ES6 imports/exports (type: "module" in package.json)

### Data Flow Patterns
- All async functions use async/await
- Functions return structured objects: `{ success, data/error, ...metadata }`
- Analysis results include: `{ photoPath, scores: { individual, summary }, analysisText, timestamp }`
- Configuration loaded from JSON (validated where needed)

### Error Handling Pattern
Seen throughout [src/analysis/photo-analyzer.js](src/analysis/photo-analyzer.js#L11-L60):
```javascript
try {
  // 1. Validate/load input
  // 2. Call Ollama or process data
  // 3. Parse/transform response
  return { success: true, data: ... };
} catch (error) {
  logger.error(`Context: ${error.message}`);
  return { success: false, error: error.message, ... };
}
```

### Logging Convention
Use [src/utils/logger.js](src/utils/logger.js) - provides `logger.section()`, `logger.info()`, `logger.debug()`, `logger.success()`, `logger.error()` with chalk colors. Example in [src/cli/analyze.js](src/cli/analyze.js#L23).

## Data Schemas & Configuration

### Open Call Config Format (JSON)
Location: `data/open-calls/{call-name}/open-call.json`

Required fields:
```json
{
  "title": "Competition Name (string)",
  "theme": "Photography theme/subject description (string)",
  "jury": ["Jury member 1", "Jury member 2", "..."],
  "pastWinners": "Paragraph describing winning photo characteristics (string)",
  "context": "Optional additional context for evaluation"
}
```

Example: [data/open-calls/example-template/open-call.json](data/open-calls/example-template/open-call.json)

### Analysis Prompt Structure (Generated by Ollama)
Output by `generateAnalysisPrompt()`, stored as `analysis-prompt.json`:
```json
{
  "criteria": [
    {
      "name": "Composition",
      "description": "Visual balance and framing",
      "weight": 25
    }
  ],
  "evaluationInstructions": "Detailed instructions for LLaVA..."
}
```

### Individual Photo Analysis Result
Output by `analyzePhoto()`:
```json
{
  "photoPath": "/path/to/photo.jpg",
  "filename": "photo.jpg",
  "scores": {
    "individual": {
      "Composition": { "score": 8.5, "feedback": "Strong rule of thirds..." },
      "Lighting": { "score": 7.8, "feedback": "Well-exposed..." }
    },
    "summary": {
      "average": 8.15,
      "weighted_average": 8.23
    }
  },
  "analysisText": "Full LLM response text",
  "timestamp": "2025-01-28T...",
  "model": "llava:7b"
}
```

### Score Parsing Pattern
In `parseAnalysisResponse()` from [src/analysis/photo-analyzer.js](src/analysis/photo-analyzer.js):
- LLaVA response must contain lines matching pattern: `CRITERION: [name] | SCORE: [1-10]`
- Optional feedback lines: `FEEDBACK: [text]`
- Weighted averages calculated by multiplying scores by criterion weights
- Fallback: If no structured scores found, returns minimal analysis with error flag

## Testing & Validation

- **Test Framework**: Jest with async support (`npm test`)
- **Test Location**: [tests/](tests/) directory mirrors src structure
- **Mock Ollama**: Tests use `jest.mock('../utils/api-client.js')` (see [tests/api-client.test.js](tests/api-client.test.js))
- **Key Test Cases**: Error handling, parsing LLM responses, score aggregation, batch parallelism

Run tests: `npm test` or `npm run test:watch`

## Development Commands

```bash
npm start                   # Run main CLI (delegates to analyze.js)
npm run dev                 # Watch mode with --watch flag
npm run analyze            # Direct access to analyze.js CLI
npm run analyze analyze data/open-calls/nature-wildlife/  # Full workflow
npm run analyze analyze-single ./path/to/photo.jpg        # Single photo
npm run analyze validate data/open-calls/nature-wildlife/  # Check structure
npm test                   # Jest test suite
npm run test:watch        # Jest watch mode
npm run lint              # ESLint
npm run format            # Prettier formatting
```

### Typical Development Workflow
```bash
# 1. Verify Ollama is running
ollama list  # Should show llava:7b

# 2. Create a test project
mkdir -p data/open-calls/my-project/photos
cp data/open-calls/example-template/open-call.json data/open-calls/my-project/

# 3. Add test photos
cp path/to/photo*.jpg data/open-calls/my-project/photos/

# 4. Run analysis (first time generates analysis-prompt.json)
npm run analyze data/open-calls/my-project/

# 5. Check results
cat results/photo-analysis.md
```

## Key Files by Function

| File | Purpose | Key Exports |
|------|---------|-------------|
| [src/analysis/photo-analyzer.js](src/analysis/photo-analyzer.js) | Core vision analysis via Ollama | `analyzePhoto()`, `buildAnalysisPrompt()`, `parseAnalysisResponse()` |
| [src/analysis/prompt-generator.js](src/analysis/prompt-generator.js) | Generate evaluation criteria from competition | `generateAnalysisPrompt()` |
| [src/analysis/score-aggregator.js](src/analysis/score-aggregator.js) | Combine individual scores, create rankings | `aggregateScores()`, `generateTiers()`, `generateStatistics()` |
| [src/processing/batch-processor.js](src/processing/batch-processor.js) | Parallel photo processing | `processBatch()`, `getPhotoFiles()` |
| [src/output/report-generator.js](src/output/report-generator.js) | Output in Markdown/JSON/CSV | `generateMarkdownReport()`, `exportReports()` |
| [src/utils/api-client.js](src/utils/api-client.js) | Ollama connection management | `getApiClient()`, `checkOllamaStatus()` |
| [src/cli/analyze.js](src/cli/analyze.js) | CLI command handler | Program definition with subcommands |

## Before You Code

**Always check these first:**
1. [ROADMAP.md](ROADMAP.md) - Understand what milestone/phase you're in
2. [BACKLOG.md](BACKLOG.md) - See task assignments and priorities
3. [QUICKSTART.md](QUICKSTART.md) - Project setup & common workflows
4. [CLAUDE.md](CLAUDE.md) - Multi-agent collaboration context

**Environment Setup:**
- Node.js 20+ required
- Ollama running locally on `http://localhost:11434`
- LLaVA 7B model: `ollama pull llava:7b`

## Key Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| `ollama` | ^0.5.11 | SDK for local Ollama server communication |
| `sharp` | ^0.33.5 | Image processing (validation, resizing) |
| `commander` | ^12.1.0 | CLI argument parsing |
| `ora` | ^8.1.0 | Elegant terminal spinners |
| `chalk` | ^5.3.0 | Terminal color output |
| `cli-table3` | ^0.6.5 | ASCII table formatting for reports |

**Important**: Node.js 20+ required (type: "module" in package.json uses ES6 imports)

## Common Implementation Patterns

### Adding Analysis Criteria
In `photo-analyzer.js`, criteria parsed from LLM response using pattern like:
```
CRITERION: [name]
DESCRIPTION: [desc]
WEIGHT: [%]
```
See `buildAnalysisPrompt()` and `parseAnalysisResponse()` for pattern matching.

### Extending Batch Processing
`processBatch()` spawns parallel tasks with configurable concurrency. To add new post-processing, modify results handling before `exportReports()`.

### Adding Report Formats
Extend [src/output/report-generator.js](src/output/report-generator.js) - add new export functions like `generateCsvReport()` and call from CLI.

## What NOT To Do

- ❌ Don't hardcode paths - use [src/utils/file-utils.js](src/utils/file-utils.js) and `join()`
- ❌ Don't create new Ollama clients - use `getApiClient()` from api-client.js
- ❌ Don't log directly - use logger utilities
- ❌ Don't process photos serially - use `processBatch()` with parallel option
- ❌ Don't assume LLM response format - always parse defensively with fallbacks

## Debugging Tips

- **Ollama not responding?** Check `ollama list` returns llava model
- **Photo analysis fails?** Enable debug logging: `DEBUG=* npm run analyze`
- **Scores all zeros?** Verify LLM parsing in `parseAnalysisResponse()` matches actual response format
- **Batch timeout?** Reduce `parallel` option in [src/cli/analyze.js](src/cli/analyze.js#L26)

## Git Workflow & Branch Protection

### Branch Protection Rules
**CRITICAL**: Direct commits to `main` are NOT permitted.

**All changes must follow this workflow:**

1. **Create feature branch** from `main`:
   ```bash
   git checkout -b feature/[milestone]-[feature-name]
   # Example: feature/m2-config-validation
   ```

2. **Make changes** on the feature branch

3. **Push to remote**:
   ```bash
   git push origin feature/[milestone]-[feature-name]
   ```

4. **Create Pull Request** on GitHub and request review

5. **Merge only via PR** (never direct commits to main)

### Branch Naming Conventions

| Type | Pattern | Example |
|------|---------|-------------|
| Feature | `feature/[milestone]-[feature]` | `feature/m2-resume-analysis` |
| Bug Fix | `fix/[issue-name]` | `fix/timeout-handling` |
| Documentation | `docs/[topic]` | `docs/test-design` |
| BMAD | `bmad/[opportunity]` | `bmad/prd-architecture` |

**See COPILOT.md for detailed git workflow.**

## Language Guidelines

**IMPORTANT**: All documentation and code comments MUST be in English only.

- ✅ **DO**: Write all documentation in English
- ✅ **DO**: Write all inline code comments in English
- ✅ **DO**: Use English for commit messages
- ✅ **DO**: Use English for issue descriptions and PR titles
- ❌ **DON'T**: Use Italian or any other language in documentation
- ❌ **DON'T**: Use Italian in code comments
- ❌ **DON'T**: Use Italian in variable/function names
- ❌ **DON'T**: Use Italian in git commit messages

All future documentation and inline code comments must be in English. This applies to:
- Markdown files (README, ROADMAP, BACKLOG, etc.)
- Inline code comments
- Commit messages
- Pull request descriptions
- Issue descriptions
- Variable and function names
